{% extends "base.html" %}

{% load staticfiles %}
{% load common_tags %}

{% block sitetitle %}| Administration{% endblock %}
{% block heading %}Admin Portal <small>Knowledgebase</small>{% endblock %}

{% block breadcrumbs %}
	<li><a>Support</a></li>
	<li><a href="{% url 'knowledgebase:index' %}">Knowledgebase</a></li>
  {% if article_id > 0 %}
	 <li><a href="{% url 'knowledgebase:index' %}" id="breadcrumb-category-title"></a></li>
   <li><a href="{% url 'knowledgebase:index' %}" id="breadcrumb-article-title"></a></li>
  {% endif %}
  <li>Administration</li>

{% endblock %}

{% block js %}
	<script type="text/javascript">
    function deleteKnowledgebaseArticle() {
      function onSuccessCallback(result) {
        if(!jQuery.isEmptyObject(result)) {
          $('#flash-message').fadeIn();
          if(result.success == 1) {
            $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
            window.location = "{% url 'knowledgebase:index' %}";
          }
          else {
            $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
          }
        }
        setTimeout("$('#flash-message').fadeOut()",2000);
      }

      $.ajax({
        url: "{%url 'knowledgebase:delarticle' %}",
        type: "POST",
        data: {"article_id": {{ article_id }}},
        success: onSuccessCallback,
        error: defaultErrorCallback
      });
    }

    function setKnowledgebaseTag() {
      function onSuccessCallback(result) {
        if(!jQuery.isEmptyObject(result)) {
          $('#flash-message').fadeIn();
          if(result.success == 1) {
            $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
            $("#kb-tag-title").val("");
            getKnowledgebaseTags();
            $('.modal.in').modal('hide');
          }
          else {
            $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
            if(result.hasOwnProperty('errors')) {
              $.each(result.errors, function(k,v) {
                $("#"+k+"-help").closest('div').addClass("has-error");
                $("#"+k+"-help").html(v);
              });
            }
          }
          setTimeout("$('#flash-message').fadeOut()",2000);
        }
      }

      $.ajax({
        url: "{% url 'knowledgebase:settag' %}",
        type: "POST",
        data: $("#kb-tag-set-form").serialize(),
        success: onSuccessCallback,
        error: defaultErrorCallback
      });
    }

      function getKnowledgebaseTags() {
        $("#tags-listing").html("");
        $("#tags-table-tbody").html("");

        function onSuccessCallback(result) {
          if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
              for(x in result.data.tags) {
                $("#tags-listing").append('<OPTION value="'+result.data.tags[x].id+'">'+result.data.tags[x].title+'</OPTION>');
                $("#tags-table-tbody").append(' \
                  <tr data-id="'+result.data.tags[x].id+'"> \
                    <td>'+result.data.tags[x].id+'</td> \
                    <td>'+result.data.tags[x].title+'</td> \
                    <td style="text-align: right"> \
                      <a href="#" class="edit-tag" role="button"><i class="fa fa-edit" style="color: green"></i></a> \
                      <a href="#" class="del-tag" role="button"><i class="fa fa-trash-o" style="color: red"></i></a> \
                    </td> \
                  </tr>'
                );
              }
            }
            else {
              $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
            }
          }
        }

        $.ajax({
          url: "{% url 'knowledgebase:gettags' %}",
          type: "POST",
          success: onSuccessCallback,
          error: defaultErrorCallback
        });
      }

      function getKnowledgebaseCategories() {
        $("#categories-listing").html("");
        $("#categories-table-tbody").html("");

        function onSuccessCallback(result) {
          if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
              for(x in result.data.categories) {
                $("#categories-listing").append('<OPTION value="'+result.data.categories[x].id+'">'+result.data.categories[x].title+'</OPTION>');
                $("#categories-table-tbody").append(' \
                  <tr data-id="'+result.data.categories[x].id+'"> \
                    <td>'+result.data.categories[x].id+'</td> \
                    <td>'+result.data.categories[x].title+'</td> \
                    <td style="text-align: right"> \
                      <a href="#" role="button" class="edit-category"><i class="fa fa-edit" style="color: green"></i></a> \
                      <a href="#" role="button" class="del-category"><i class="fa fa-trash-o" style="color: red"></i></a> \
                    </td> \
                  </tr>'
                );
              }
            }
            else {
              $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
            }
          }
        }

        $.ajax({
          url: "{% url 'knowledgebase:getcategories' %}",
          type: "POST",
          success: onSuccessCallback,
          error: defaultErrorCallback
        });
      }

      function setKnowledgebaseCategory() {
        function onSuccessCallback(result) {
          if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
              $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
              $("#kb-category-title").val("");
              getKnowledgebaseCategories();
              $('.modal.in').modal('hide');
            }
            else {
              $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
              if(result.hasOwnProperty('errors')) {
                $.each(result.errors, function(k,v) {
                  $("#"+k+"-help").closest('div').addClass("has-error");
                  $("#"+k+"-help").html(v);
                });
              }
            }
            setTimeout("$('#flash-message').fadeOut()",2000);
          }
        }

        $.ajax({
          url: "{% url 'knowledgebase:setcategory' %}",
          type: "POST",
          data: $('#kb-category-set-form').serialize(),
          success: onSuccessCallback,
          error: defaultErrorCallback
        });
      }

      function setKnowledgebaseArticle() {
        function onSuccessCallback(result) {
          if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
              $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
              window.location = "/support/kb/"+result.data.article_id;
            }
            else {
              $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
              if(result.hasOwnProperty('errors')) {
                $.each(result.errors, function(k,v) {
                  $("#"+k+"-help").closest('div').addClass("has-error");
                  $("#"+k+"-help").html(v);
                });
              }
            }
            setTimeout("$('#flash-message').fadeOut()",2000);
          }
        }

        $.ajax({
          url: "{% url 'knowledgebase:setarticle' %}",
          type: "POST",
          data: $("#kb-article-form").serialize(),
          success: onSuccessCallback,
          error: defaultErrorCallback
        });
      }


      function deleteKnowledgebaseCategory() {
        function onSuccessCallback(result) {
          if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
              $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
              getKnowledgebaseCategories();
              $('.modal.in').modal('hide');
            }
            else {
              $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
            }
            setTimeout("$('#flash-message').fadeOut()",2000);
          }
        }

        $.ajax({
          url: "{% url 'knowledgebase:delcategory' %}",
          type: "POST",
          data: $("#kb-category-del-form").serialize(),
          success: onSuccessCallback,
          error: defaultErrorCallback
        });
      }

      function deleteKnowledgebaseTag() {
        function onSuccessCallback(result) {
          if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
              $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
              getKnowledgebaseTags();
              $('.modal.in').modal('hide');
            }
            else {
              $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
            }
            setTimeout("$('#flash-message').fadeOut()",2000);
          }
        }

        $.ajax({
          url: "{% url 'knowledgebase:deltag' %}",
          type: "POST",
          data: $("#kb-tag-del-form").serialize(),
          success: onSuccessCallback,
          error: defaultErrorCallback
        });
      }

      function resetKnowledgebaseTagForm() {
        $("#kb-tag-set-form #tag_id").val("");
        $("#kb-tag-set-form #kb-tag-title").val("");
        $("#kb-tag-set-modal").modal('show');
      }

      function resetKnowledgebaseCategoryForm() {
        $("#kb-category-set-form #category_id").val("");
        $("#kb-category-set-form #kb-category-title").val("");
        $("#kb-category-set-modal").modal('show');
      }
	</script>
{% endblock %}

{% block jquery_document_ready %}
	getKnowledgebaseTags();
	getKnowledgebaseCategories();

  $('#categories-table-tbody')
      .on('click', 'a.del-category', function (e) {
          e.preventDefault();
          $("#kb-category-del-form #category_id").val($(this).closest('tr').data('id'))
          $("#kb-category-del-modal").modal('show');
      })
      .on('click', 'a.edit-category', function (e) {
          e.preventDefault();
          resetKnowledgebaseCategoryForm();
          $("#kb-category-set-form #kb-category-title").val($(this).closest('tr').find("td").eq(1).html());
          $("#kb-category-set-form #category_id").val($(this).closest('tr').data('id'))
      })

  $('#tags-table-tbody')
      .on('click', 'a.del-tag', function (e) {
          e.preventDefault();
          $("#kb-tag-del-form #tag_id").val($(this).closest('tr').data('id'))
          $("#kb-tag-del-modal").modal('show');
      })
      .on('click', 'a.edit-tag', function (e) {
          e.preventDefault();
          resetKnowledgebaseTagForm();
          $("#kb-tag-title").val($(this).closest('tr').find("td").eq(1).html());
          $("#kb-tag-set-form #tag_id").val($(this).closest('tr').data('id'))
      })
{% endblock %}

{% block content %}
  <!-- BEGIN KNOWLEDGEBASE ADMINISTRATION CONTENT -->
    <!-- BEGIN CONTAINER HEAD -->
    <div class="row page-head">
        <div class="col-md-12"><i class="fa fa-book"></i>&nbsp;<h3>Knowledgebase</h3></div>
    </div>
    <!-- END CONTAINER HEAD -->
    <!-- BEGIN CONTAINER BODY -->
		<div class="row">
        <!-- BEGIN KB ARTICLE FORM -->
        <form role="form" class="form col-md-12" id="kb-article-form">
            {% csrf_token %}
            <input type="hidden" name="article_id" value="{{ article_id }}" />
            <table class="table table-striped table-bordered table-hover" id="kb-article-form-table">
                {% for field in articleform %}
                    <tr class="form-group">
                        <td><label class="control-label">{{ field.label_tag }}</label></td>
                        <td>
                            <div class="controls">
                                {{ field|addcss:"form-control" }}
                                <span id="{{ field.html_name }}-help" class="help-inline"></span>
                            </div>
                        </td>
                    </tr>
                {% endfor %}

                <tr class="form-actions">
                  <td>&nbsp;</td>
                  <td>
                    <a class="btn btn-primary" onclick="setKnowledgebaseArticle()"><i class="fa fa-plus"></i> Submit</a>
                    {% if article_id > 0 %}
                        <a class="btn btn-danger" onclick="$('#kb-article-del-modal').modal('show');"><i class="fa fa-minus"></i> Delete</a>
                    {% endif %}
                  </td>
                </tr>
            </table>
        </form>
        <!-- END KB ARTICLE FORM -->
		</div>
    <!-- END CONTAINER BODY -->

<div class="row">
    <div class="col-md-5">
    <!-- BEGIN VLAN CONTAINER HEAD -->
    <div class="row page-head">
        <div class="col-md-6"><i class="fa fa-folder"></i>&nbsp;<h3 id="article-title">Categories</h3></div>
        <div class="col-md-6 text-right">
            <div class="btn-group">
                <a href="#" role="button" onclick="resetKnowledgebaseCategoryForm()"><i class="fa fa-plus"></i></a>
            </div>
        </div>
    </div>
    <!-- END VLAN CONTAINER HEAD -->
    <!-- BEGIN VLAN CONTAINER BODY -->
    <div class="row">
        <!-- BEGIN VLAN TABLE -->
        <table id="categories-table" class="table table-hover">
            <thead class="row">
                <tr>
                  <th class="col-md-2">ID</th>
                  <th class="col-md-8">Name</th>
                  <th class="col-md-2">&nbsp;</th>
                </tr>
            </thead>
            <tbody id="categories-table-tbody">
            </tbody>
        </table>
        <!-- END VLAN TABLE -->
    </div>
    <!-- END VLAN CONTAINER BODY -->
</div><div class="col-md-offset-2 col-md-5">
    <!-- BEGIN VLAN CONTAINER HEAD -->
    <div class="row page-head">
        <div class="col-md-6"><i class="fa fa-tags"></i>&nbsp;<h3 id="article-title">Tags</h3></div>
        <div class="col-md-6 text-right">
            <div class="btn-group">
                <a href="#" role="button" onclick="resetKnowledgebaseTagForm()"><i class="fa fa-plus"></i></a>
            </div>
        </div>
    </div>
    <!-- END VLAN CONTAINER HEAD -->
    <!-- BEGIN VLAN CONTAINER BODY -->
    <div class="row">
        <!-- BEGIN VLAN TABLE -->
        <table id="tags-table" class="table table-hover">
            <thead>
                <tr>
                  <th class="col-md-2">ID</th>
                  <th class="col-md-8">Name</th>
                  <th class="col-md-2">&nbsp;</th>
                </tr>
            </thead>
            <tbody id="tags-table-tbody">
            </tbody>
        </table>
        <!-- END VLAN TABLE -->
    </div>
    <!-- END VLAN CONTAINER BODY -->
    </div>
</div>

    <!-- BEGIN SET KB TAG MODAL -->
    <div id="kb-tag-set-modal" class="modal fade in" role="dialog" aria-labelledby="model-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- BEGIN MODAL HEADER -->
          <div class="modal-header">
            <h3 id="mlabel">Knowledgebase Tag</h3>
          </div>
          <!-- END MODAL HEADER -->
          <!-- BEGIN MODAL BODY -->
          <div class="modal-body">
            <div id="flash-message"></div>
            <div class="well" id="mbody">
                <form id="kb-tag-set-form">
                  <div class="form-group">
                      <label class="control-label col-md-3">Title</label>
                      <div class="controls col-md-9">
                          <input class="form-control" id="kb-tag-title" maxlength="100" name="title" type="text" value="" />
                          <span id="title-help" class="help-block"></span>
                      </div>
                  </div>
                  <input type="hidden" name="tag_id" id="tag_id" value="" />
                </form>

            </div>
          </div>
          <!-- END MODAL BODY -->
          <!-- BEGIN MODAL FOOTER -->
          <div class="modal-footer" id="modalfooter">
            <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Close</button>
            <button id="msave" class="btn btn-primary" onclick="setKnowledgebaseTag()">Ok</button>
          </div>
          <!-- END MODAL FOOTER -->
        </div>
      </div>
    </div>
    <!-- END SET KB TAG MODAL -->

    <!-- BEGIN SET KB CATEGORY MODAL -->
    <div id="kb-category-set-modal" class="modal fade in" role="dialog" aria-labelledby="model-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- BEGIN MODAL HEADER -->
          <div class="modal-header">
            <h3 id="mlabel">Knowledgebase Category</h3>
          </div>
          <!-- END MODAL HEADER -->
          <!-- BEGIN MODAL BODY -->
          <div class="modal-body">
            <div id="flash-message"></div>
            <div class="well" id="mbody">
                <!-- BEGIN KB CATEGORY FORM -->
                <form id="kb-category-set-form">
                  <div class="form-group">
                      <label class="control-label col-md-3">Title</label>
                      <div class="controls col-md-9">
                          <input class="form-control" id="kb-category-title" maxlength="100" name="title" type="text" value="" />
                          <span id="title-help" class="help-block"></span>
                      </div>
                  </div>
                  <input type="hidden" name="category_id" id="category_id" value=""/>
                </form>
                <!-- END KB CATEGORY FORM -->
            </div>
          </div>
          <!-- END MODAL BODY -->
          <!-- BEGIN MODAL FOOTER -->
          <div class="modal-footer" id="modalfooter">
            <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Close</button>
            <button id="msave" class="btn btn-primary" onclick="setKnowledgebaseCategory()">Ok</button>
          </div>
          <!-- END MODAL FOOTER -->
        </div>
      </div>
    </div>
    <!-- END SET KB CATEGORY MODAL -->

    <!-- BEGIN DELETE CATEGORY MODAL -->
    <div id="kb-category-del-modal" class="modal fade in" role="dialog" aria-labelledby="model-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- BEGIN MODAL HEADER -->
          <div class="modal-header">
            <h3 id="mlabel">Knowledgebase Category</h3>
          </div>
          <!-- END MODAL HEADER -->
          <!-- BEGIN MODAL BODY -->
          <div class="modal-body">
            <div id="flash-message"></div>
            <div class="well" id="mbody">
                <!-- BEGIN KB CATEGORY FORM -->
                <span>Are you sure you want to delete the selected Knowledgebase Category?</span>
                <form id='kb-category-del-form'>
                  <input type='hidden' name='category_id' id="category_id" value='' />
                </form>
                <!-- END KB CATEGORY FORM -->
            </div>
          </div>
          <!-- END MODAL BODY -->
          <!-- BEGIN MODAL FOOTER -->
          <div class="modal-footer" id="modalfooter">
            <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Close</button>
            <button id="msave" class="btn btn-primary" onclick="deleteKnowledgebaseCategory()">Ok</button>
          </div>
          <!-- END MODAL FOOTER -->
        </div>
      </div>
    </div>
    <!-- END DELETE CATEGORY MODAL -->

    <!-- BEGIN DELETE KB TAG MODAL -->
    <div id="kb-tag-del-modal" class="modal fade in" role="dialog" aria-labelledby="model-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- BEGIN MODAL HEADER -->
          <div class="modal-header">
            <h3 id="mlabel">Knowledgebase Tag</h3>
          </div>
          <!-- END MODAL HEADER -->
          <!-- BEGIN MODAL BODY -->
          <div class="modal-body">
            <div id="flash-message"></div>
            <div class="well" id="mbody">
                <!-- BEGIN KB CATEGORY FORM -->
                <span>Are you sure you want to delete the selected Knowledgebase Tag?</span>
                <form id='kb-tag-del-form'>
                  <input type='hidden' name='tag_id' id="tag_id" value='' />
                </form>
                <!-- END KB CATEGORY FORM -->
            </div>
          </div>
          <!-- END MODAL BODY -->
          <!-- BEGIN MODAL FOOTER -->
          <div class="modal-footer" id="modalfooter">
            <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Close</button>
            <button id="msave" class="btn btn-primary" onclick="deleteKnowledgebaseTag()">Ok</button>
          </div>
          <!-- END MODAL FOOTER -->
        </div>
      </div>
    </div>
    <!-- END DELETE KB TAG MODAL -->

    <!-- BEGIN DELETE KB ARTICLE MODAL -->
    <div id="kb-article-del-modal" class="modal fade in" role="dialog" aria-labelledby="model-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- BEGIN MODAL HEADER -->
          <div class="modal-header">
            <h3 id="mlabel">Knowledgebase Article</h3>
          </div>
          <!-- END MODAL HEADER -->
          <!-- BEGIN MODAL BODY -->
          <div class="modal-body">
            <div id="flash-message"></div>
            <div class="well" id="mbody">
                <!-- BEGIN KB CATEGORY FORM -->
                <span>Are you sure you want to delete the selected Knowledgebase Article?</span>
                <form id='kb-article-del-form'>
                  <input type='hidden' name='article_id' id="article_id" value='' />
                </form>
                <!-- END KB CATEGORY FORM -->
            </div>
          </div>
          <!-- END MODAL BODY -->
          <!-- BEGIN MODAL FOOTER -->
          <div class="modal-footer" id="modalfooter">
            <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Close</button>
            <button id="msave" class="btn btn-primary" onclick="deleteKnowledgebaseArticle()">Ok</button>
          </div>
          <!-- END MODAL FOOTER -->
        </div>
      </div>
    </div>
    <!-- END DELETE KB ARTICLE MODAL -->
 <!-- END KNOWLEDGEBASE ADMINISTRATION CONTENT -->
{% endblock %}