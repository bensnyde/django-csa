{% extends "base.html" %}

{% load staticfiles %}
{% load common_tags %}

{% block sitetitle %}| Dashboard{% endblock %}
{% block heading %}Admin Portal <small>Dashboard</small>{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{% static '/assets/plugins/data-tables/DT_bootstrap.css' %}" />
{% endblock %}

{% block js %}
  <script type="text/javascript" src="{% static '/assets/plugins/data-tables/jquery.dataTables.js' %}"></script>
  <script type="text/javascript" src="{% static '/assets/plugins/data-tables/DT_bootstrap.js' %}"></script>

  <script type="text/javascript">
      function build_announcements_modal() {
        var modal_title = "Announcements Posting";
        var modal_onclick_action = "addNewsPosting()";
        var modal_body = ' \
            <form id="announcements-form"> \
              <div class="form-group"> \
                <label class="control-label col-md-3">Title</label> \
                <div class="controls col-md-9"> \
                  <input type="text" class="form-control" name="title" id="news-article-title" /> \
                  <span id="title-help" class="help-block"></span> \
                </div> \
              </div> \
              <div class="form-group"> \
                <label class="control-label col-md-3">Public</label> \
                <div class="controls col-md-9"> \
                  <input type="checkbox" class="form-control" name="public" id="news-article-public" /> \
                  <span id="public-help" class="help-block"></span> \
                </div> \
              </div> \
              <div class="form-group"> \
                <label class="control-label col-md-3">Contents</label> \
                <div class="controls col-md-9"> \
                  <TEXTAREA class="form-control" name="body" id="news-article-contents"></TEXTAREA> \
                  <span id="body-help" class="help-block"></span> \
                </div> \
              </div> \
            </form>';

        buildModal(modal_title, modal_body, modal_onclick_action);
      }

      function addNewsPosting() {
          function onSuccessCallback(result) {
              if(!jQuery.isEmptyObject(result)) {
                  $('#flash-message').fadeIn();
                  if(result.success == 1) {
                      // AJAX call returned successful
                      $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
                      getNews();
                      $('.modal.in').modal('hide');
                  }
                  else {
                      // AJAX call returned failed
                      $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
                      if(result.hasOwnProperty('errors')) {
                          // iterate through and display form validation errors
                          $.each(result.errors, function(k,v) {
                              $("#"+k+"-help").closest('div').addClass("has-error");
                              $("#"+k+"-help").html(v);
                          });
                      }
                  }
                  setTimeout("$('#flash-message').fadeOut()",2000);
              }
          }

          // Make the AJAX call
          $.ajax({
              url: "{% url 'announcements:setnews' %}",
              type: "POST",
              data: {
                  title: $("#news-article-title").val(),
                  body: $("#news-article-contents").val(),
              },
              success: onSuccessCallback,
              error: defaultErrorCallback
          });
      }

      function delNewsPosting() {
          function onSuccessCallback(result) {
              if(!jQuery.isEmptyObject(result)) {
                  $('#flash-message').fadeIn();
                  if(result.success == 1) {
                      // AJAX call returned successful
                      $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
                  }
                  else {
                      // AJAX call returned failed
                      $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
                      if(result.hasOwnProperty('errors')) {
                          // iterate through and display form validation errors
                          $.each(result.errors, function(k,v) {
                              $("#id_"+k).closest('div').addClass("has-error");
                              $("#"+k+"-help").html(v);
                          });
                      }
                  }
                  setTimeout("$('#flash-message').fadeOut()",2000);
              }
          }

          // Make the AJAX call
          $.ajax({
              url: "{% url 'announcements:delnews' %}",
              type: "POST",
              data: {news_id: 3},
              success: onSuccessCallback,
              error: defaultErrorCallback
          });
      }

        // Fetch Support Tickets summary via AJAX
        function getNews() {
          // Destroy existing
          $("#news-postings").html("");

            // onSuccess callback function
            function onSuccessCallback(result) {
                 if(!jQuery.isEmptyObject(result)) {
                    if(result.success==1) {
                        // AJAX call returned successful
                        if(result.data.news.length > 0) {
                            for(x in result.data.news) {
                                $("#news-postings").append(' \
                                    <!-- BEGIN POSTING --> \
                                    <div class="list-group-item"> \
                                        <div class="row"> \
                                            <div class="col-md-5" style="text-indent: 10px"><strong>'+result.data.news[x].title+'</strong></div> \
                                            <div class="col-md-7 text-right"><small>'+result.data.news[x].author+' @ '+result.data.news[x].timestamp+'</small></div> \
                                        </div> \
                                        <div class="row"> \
                                            <p class="col-md-12 text-justify" style="text-indent: 6px; margin-top: 10px">'+result.data.news[x].body+'</p> \
                                        </div> \
                                    </div> \
                                    <!-- END POSTING -->');
                            }
                        }
                        else {
                            // No articles returned
                            $("#news-postings").html('<div class="alert text-center">No News</div>');
                        }
                    }
                 }
                 else {
                    // AJAX call returned failed
                    $("#news-postings").html('<div class="alert alert-danger text-center">'+result.message+'.</div>');
                 }
            }

            // Make the AJAX call
            $.ajax({
                url: "{% url 'announcements:getnews' %}",
                type: "POST",
                success: onSuccessCallback,
                error: defaultErrorCallback
            });
        }

        // Fetch Tickets listing via AJAX
        function getTickets() {
          // Destroy existing
            $("#tickets-tbody").html("");

            // onSuccess callback function
            function onSuccessCallback(result) {
                if(!jQuery.isEmptyObject(result)) {
                    if(result.success == 1) {
                      // AJAX call returned successful
                      if(result.data.tickets.length == 0)
                      {
                        $("#tickets-tbody").html('<tr><td colspan=5>There are no open tickets.</td></tr>');
                      }
                      else {
                        for(x in result.data.tickets) {
                            var priority = "gray";
                            if(result.data.tickets[x].priority=="Urgent") {
                              priority = "red";
                            }
                            else if(result.data.tickets[x].priority=="Normal") {
                              priority = "green"
                            }

                            $("#tickets-tbody").append(' \
                                <tr data-id="'+result.data.tickets[x].id+'" style="background-color: '+priority+'"> \
                                    <td>'+result.data.tickets[x].id+'</td> \
                                    <td>'+result.data.tickets[x].description+'</td> \
                                    <td>'+result.data.tickets[x].author+'</td> \
                                    <td>'+result.data.tickets[x].owner+'</td> \
                                    <td>'+result.data.tickets[x].lastupdate+'</td> \
                                </tr>'
                            );
                        }
                      }
                    }
                    else {
                      // AJAX call returned failed
                        $("#tickets-tbody").html("<tr><td colspan=5>"+result.message+"</td></tr>");
                    }
                }
            }

            // Make the AJAX call
            $.ajax({
                url: "{%url 'tickets:gettickets' %}",
                type: "POST",
                data: {"flagged": 1},
                success: onSuccessCallback,
                error: defaultErrorCallback
            });
        }
  </script>
{% endblock %}

{% block jquery_document_ready %}
  getNews();
  getTickets();

  $("#tickets-tbody").on('click', 'tr', function () {
    if($(this).data('id')) {
      window.location = "{% url 'tickets:detail' 0 %}".replace('0', $(this).data('id'));
    }
  });
{% endblock %}

{% block content %}
<!-- BEGIN BACKEND CONTENT -->
  <div id="flash-message"></div>
  <div class="row">
    <!-- BEGIN NEWS CONTAINER -->
    <div class="col-md-6">
        <div class="panel panel-default">
          <div class="panel-heading" style="font-weight: bold">
          <div style="float: right"><a href="#" onclick="build_announcements_modal()"><i class="fa fa-plus"></i></a></div>
            <div>Announcements</div>
          </div>

          <div class="panel-body">
            <!-- BEGIN NEWS POSTINGS -->
            <div id="news-postings" class="list-group"></div>
            <!-- END NEWS POSTINGS -->
          </div>
        </div>
    </div>
    <!-- END NEWS CONTAINER -->
    <!-- BEGIN TICKETS CONTAINER -->
    <div class="col-md-6">
        <div class="panel panel-default">
          <div class="panel-heading" style="font-weight: bold">Open Tickets
            <span class="pull-right"><a href="{% url 'tickets:create_ticket' %}"><i class="fa fa-plus"></i></a></span></div>
          <div class="panel-body">
            <!-- BEGIN FLAGGED TICKETS -->
            <div id="flagged-tickets" class="list-group">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Description</th>
                    <th>Author</th>
                    <th>Owner</th>
                    <th>Last Update</th>
                </thead>
                <tbody id="tickets-tbody"></tbody>
              </table>
            </div>
            <!-- END FLAGGED TICKETS -->
          </div>
        </div>
      </div>
      <!-- END TICKETS CONTAINER -->
    </div>
  </div>

  <!-- BEGIN MODAL -->
  <div id="mmodal" class="modal fade in" role="dialog" aria-labelledby="model-label" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <!-- BEGIN MODAL HEADER -->
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                  <h3 id="mlabel"></h3>
              </div>
              <!-- END MODAL HEADER -->
              <!-- BEGIN MODAL BODY -->
              <div class="modal-body">
                  <div id="flash-message"></div>
                  <div class="well" id="mbody"></div>
              </div>
              <!-- END MODAL BODY -->
              <!-- BEGIN MODAL FOOTER -->
              <div class="modal-footer" id="modalfooter">
                  <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Close</button>
                  <button id="msave" class="btn btn-primary">Ok</button>
              </div>
              <!-- END MODAL FOOTER -->
          </div>
      </div>
  </div>
  <!-- END MODAL -->
<!-- END BACKEND CONTENT -->
{% endblock %}