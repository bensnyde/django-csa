{% extends "base.html" %}

{% load staticfiles %}
{% load common_tags %}

{% block sitetitle %}| Services{% endblock %}
{% block heading %}Services <small>Server Hosting</small>{% endblock %}

{% block breadcrumbs %}
	<li><a>Services</a></li>
	<li>Server Hosting</li>
{% endblock %}

{% block css %}
	<link rel="stylesheet" href="{% static '/assets/plugins/data-tables/DT_bootstrap.css' %}" />
{% endblock %}

{% block js %}
	<script type="text/javascript" src="{% static '/assets/plugins/data-tables/jquery.dataTables.js' %}"></script>
	<script type="text/javascript" src="{% static '/assets/plugins/data-tables/DT_bootstrap.js' %}"></script>
	<script type="text/javascript">
		// Fetch Servers listing via AJAX
		function getServers() {
			// Destroy existing
			$("#servers-table").dataTable().fnDestroy();
			$("#servers-tbody").html("");	
			
			// onSuccess callback function
			function onSuccessCallback(result) {
				if(!jQuery.isEmptyObject(result)) {
					if(result.success == 1) {
						// AJAX call returned success
						for(x in result.data.servers) {
							$("#servers-tbody").append(' \
						        <tr data-servid="'+result.data.servers[x].id+'"> \
						        	<td><a href="{% url 'servers:index' service_id %}'+result.data.servers[x].id+'/">'+result.data.servers[x].id+'</a></td> \
						        	<td>'+result.data.servers[x].name+'</td> \
						        	<td>'+result.data.servers[x].type+'</td> \
						        	<td>'+result.data.servers[x].os+'</td> \
						        	<td>'+result.data.servers[x].ip+'</td> \
								</tr>'
							);
						}

						// Initialize datatable
						$("#servers-table").dataTable({"aoColumnDefs": [], "aaSorting": [[0, 'asc']]});	
					}					
					else {
						// AJAX call returned failed
						$("#zones-tbody").html("<tr><td colspan=5>"+result.message+"</td></tr>");	
					}
				}				
			}

			// Make AJAX call to retrieve servers
            $.ajax({
                url: "{%url 'servers:getservers' service_id %}",
                type: "POST",
                success: onSuccessCallback,
                error: defaultErrorCallback
            });
		}

		// Fetch Servers listing via AJAX
		function setServer() {
			// Destroy existing 
			$('#flash-message').html("");

			// onSuccess callback function
			function onSuccessCallback(result) {
				if(!jQuery.isEmptyObject(result)) {
					if(result.success == 1) {
						// AJAX call returned success
	                    $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
	                    getServers();
	                    setTimeout("$('.modal.in').modal('hide')",2000);
					}					
					else {
						// AJAX call returned failed
						$('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');	
	                    if(result.hasOwnProperty('errors')) { 
	                        // iterate through and display form validation errors
	                        $.each(result.errors, function(k,v) {
	                        	console.log($("#id_"+k).closest('tr'));
	                            $("#id_"+k).closest('tr').addClass("has-error");
	                            $("#"+k+"-help").html(v);
	                        });
	                    }   						
					}
				}				
			}

			// Make AJAX call to retrieve servers
            $.ajax({
                url: "{%url 'servers:setserver' service_id %}",
                data: $('#set-server-form').serialize(),
                type: "POST",
                success: onSuccessCallback,
                error: defaultErrorCallback
            });
		}

	</script>
{% endblock %}

{% block jquery_document_ready %}
	getServers();
{% endblock %}

{% block content %}
 <!-- BEGIN SERVERS INDEX CONTENT -->

    <!-- BEGIN SERVERS CONTENT HEADER -->
    <div class="row page-head">
        <div class="col-md-6"><i class="fa fa-edit"></i>&nbsp;<h3>Servers</h3></div>
        <div class="col-md-6 text-right">        
            <div class="btn-group">
                <a onclick="$('#mmodal').modal('show');" role="button" class="badge" data-toggle="modal">Add Server <i class="fa fa-plus"></i></a>
            </div>
        </div>        
    </div>
    <!-- END SERVERS CONTENT HEADER -->

    <!-- BEGIN SERVERS INDEX CONTAINER -->
    <div class="row">
		<!-- BEGIN SERVERS TABLE -->
		<table class="table table-striped table-bordered table-hover" id="servers-table">
			<thead>
				<tr>
					<th>ID</th>
					<th>Name</th>
					<th>Type</th>
					<th>OS</th>
					<th>IP</th>
				</tr>
			</thead>
			<tbody id="servers-tbody"></tbody>
		</table>
		<!-- END SERVERS TABLE -->
	</div>
	<!-- END SERVERS INDEX CONTAINER -->

	<!-- BEGIN MODAL -->
	<div id="mmodal" class="modal fade in" role="dialog" aria-labelledby="model-label" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
					<h3 id="mlabel">Set Server</h3>
				</div>
				<div class="modal-body form">
					<!-- BEGIN MODAL BODY -->
					<div id="flash-message"></div>
					<div id="mbody" class="well">
						<form id="set-server-form">
				    		<table class="table table-striped table-bordered table-hover" id="create-contact-form-table">
								{% for field in serverform %}
									<tr class="form-group">
										<td><label class="control-label">{{ field.label_tag }}</label></td>
										<td>
											<div class="controls">
												{{ field|addcss:"form-control" }}
												<span id="{{ field.html_name }}-help" class="help-inline"></span>
											</div>            
							        	</td>
							        </tr>
							    {% endfor %}
							</table>						
						</form>
					</div>
					<!-- END MODAL BODY -->
				</div>
				<div class="modal-footer" id="modalfooter">
					<button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Close</button>
					<button id="msave" class="btn btn-primary" onclick="setServer()">Ok</button>
				</div>
			</div>
		</div>
	</div>
	<!-- END MODAL -->	

 <!-- END SERVERS INDEX CONTENT -->
{% endblock %}