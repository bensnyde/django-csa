{% extends "base.html" %}

{% load staticfiles %}
{% load common_tags %}

{% block sitetitle %}| Services{% endblock %}
{% block heading %}Services <small>Server Hosting</small>{% endblock %}

{% block breadcrumbs %}
	<li><a>Services</a></li>
	<li><a href="{% url 'servers:index' service_id %}">Server Hosting</a></li>
	<li id="server-name-breadcrumb"></li>
{% endblock %}

{% block js %}
	<script type="text/javascript">
		function getServer() {
			function onSuccessCallback(result) {
				if(!jQuery.isEmptyObject(result) && result.hasOwnProperty('message') && result.hasOwnProperty('success') && result.hasOwnProperty('data')) {
					if(result.success == 1) {
						$("#server-name-breadcrumb").html(result.data.server.name);
						$("#server-title").html(result.data.server.name);
						$("#server-name").html(result.data.server.name);
						$("#server-os").html(result.data.server.os);
						$("#server-ip").html(result.data.server.ip.address);
						$("#server-username").html(result.data.server.username);
						$("#server-password").html(result.data.server.password);
						$("#server-notes").html(result.data.server.notes);
						{% if user.is_staff %}
							$("#server-location").html(result.data.server.location);
							$("#server-uplink").html(result.data.server.uplink);
							$("#server-type").html(result.data.server.type);
							$("#server-sid").html(result.data.server.sid);
						{% endif %}

						if(result.data.server.ip.address) {
							$("#server-ip").html('<a href="{% url 'ip:index' %}'+result.data.server.ip.address+'/'+result.data.server.ip.cidr+'/">'+result.data.server.ip.address+'/'+result.data.server.ip.cidr+'</a>');
						}
					}
					else {
						$("#zones-tbody").html("<tr class='has-error'><td colspan=5><em>"+result.message+"</em></td></tr>");
					}
				}
			}

            $.ajax({
                url: "{%url 'servers:getserver' service_id server.id %}",
                type: "POST",
                success: onSuccessCallback,
                error: defaultErrorCallback
            });
		}

		function setServer() {
			function onSuccessCallback(result) {
				if(!jQuery.isEmptyObject(result) && result.hasOwnProperty('message') && result.hasOwnProperty('success')) {
	                $('.modal-alert').html(result.message);
	                $('.modal-alert').fadeIn();

					if(result.success == 1) {
	                    $('.modal-alert').addClass('alert alert-success');
	                    getServer();
	                    setTimeout("$('.modal.in').modal('hide')",500);
					}
					else {
						$('.modal-alert').addClass('alert alert-danger');
	                    if(result.hasOwnProperty('errors')) {
	                        $.each(result.errors, function(k,v) {
	                            $("#id_"+k).closest('tr').addClass("has-error");
	                            $("#"+k+"-help").html(v);
	                        });
	                    }
					}

			        setTimeout("$('.modal-alert').fadeOut()",2000);
			        $('.modal-alert').removeClass().addClass('modal-alert');
				}
			}

            $.ajax({
                url: "{%url 'servers:setserver' service_id %}",
                data: $('#set-server-form').serialize(),
                type: "POST",
                success: onSuccessCallback,
                error: defaultErrorCallback
            });
		}
	</script>
{% endblock %}

{% block jquery_document_ready %}
	getServer();

    $(document)
        .on('click', 'a.set-server-form-submit', function (e) {
            e.preventDefault();
            setServer();
        })
        .on('click', 'a.show-set-server-modal', function (e) {
            e.preventDefault();
            $('#set-server-modal').modal('show');
        });
{% endblock %}

{% block content %}
 <!-- BEGIN SERVERS INDEX CONTENT -->

    <!-- BEGIN SERVER DETAILS CONTENT HEADER -->
    <div class="row page-head">
        <div class="col-md-6"><i class="fa fa-edit"></i>&nbsp;<h3 id="server-title"></h3></div>
        <div class="col-md-6 text-right">
            <div class="btn-group">
                <a href="{% url 'tickets:create_ticket' service_id %}" role="button" class="badge" alt="Open Ticket">Open Support Request <i class="fa fa-plus"></i></a>
                <a role="button" class="badge show-set-server-modal" data-toggle="modal" alt="Edit Server">Edit Server <i class="fa fa-plus"></i></a>
            </div>
        </div>
    </div>
    <!-- END SERVER DETAILS CONTENT HEADER -->

    <!-- BEGIN SERVER DETAILS CONTAINER -->
		<!-- BEGIN SERVER STATS TABLE -->
		<table class=" table table-hover" id="server-details-table">
			<tr><td>Name</td><td id="server-name"></td></tr>
			<tr><td>Operating System</td><td id="server-os"></td></tr>
			<tr><td>IP Address</td><td id="server-ip"></td></tr>
			<tr><td>Username</td><td id="server-username"></td></tr>
			<tr><td>Password</td><td id="server-password"></td></tr>
			{% if user.is_staff %}
				<tr><td>Location</td><td id="server-location"></td></tr>
				<tr><td>Uplink</td><td id="server-uplink"></td></tr>
				<tr><td>Type</td><td id="server-type"></td></tr>
				<tr><td>SID</td><td id="server-sid"></td></tr>
			{% endif %}
			<tr><td>Notes</td><td id="server-notes"></td></tr>
		</table>
		<!-- END SERVER STATS TABLE -->

		<!-- BEGIN SERVER PLUGINS -->
   		{% if server.type == "KVM" or server.type == "XEN" %}
   			{% if server.sid %}
				{% include "solusvm/index.html" %}
   			{% endif %}
		{% elif server.type == "VMWARE" and server.sid %}
			{% include "vmware/index.html" %}
		{% elif server.type == "FARM" or server.type == "COLO" %}
			{% if server.uplink %}
				{% include "zenoss/index.html" %}
			{% endif %}
		{% endif %}
		<!-- END SERVER PLUGINS -->
    <!-- END SERVER DETAILS CONTAINER -->

	<!-- BEGIN MODAL -->
	<div id="set-server-modal" class="modal fade in" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h3>Set Server</h3>
				</div>
				<div class="modal-body">
					<!-- BEGIN MODAL BODY -->
					<div class="modal-alert"></div>
					<!-- BEGIN SET SERVER FORM -->
					<form id="set-server-form">
						<input type="hidden" name="server_id" value="{{ server.pk }}" />
			    		<table class="table table-hover" id="create-contact-form-table">
							{% for field in serverform %}
								<tr class="form-group">
									<td><label class="control-label">{{ field.label_tag }}</label></td>
									<td>
										<div class="controls">
											{{ field|addcss:"form-control" }}
											<span id="{{ field.html_name }}-help" class="help-inline"></span>
										</div>
						        	</td>
						        </tr>
						    {% endfor %}
						</table>
					</form>
					<!-- END SET SERVER FORM -->
					<!-- END MODAL BODY -->
				</div>
				<div class="modal-footer">
					<a role="button" class="btn btn-default" data-dismiss="modal">Close</a>
					<a role="button" class="btn btn-primary set-server-form-submit">Ok</a>
				</div>
			</div>
		</div>
	</div>
	<!-- END MODAL -->

 <!-- END SERVERS INDEX CONTENT -->
{% endblock %}