{% extends "base.html" %}

{% load staticfiles %}
{% load common_tags %}

{% block sitetitle %}| Support{% endblock %}
{% block heading %}Support <small>IP Space</small>{% endblock %}

{% block breadcrumbs %}
	<li><a>Support</a></li>
	<li><a href="{% url 'ip:index' %}">IP Space</a></li>
  <li>Management</li>
{% endblock %}

{% block js %}
	<script type="text/javascript">
    // Customizes modal with specifications
    function buildModal(label, body, saveaction) {
        $('#flash-message').hide();
        $('#mlabel').html(label);
        $('#mbody').html(body);    
        $('#msave').attr('onclick', saveaction);        
        $("#mmodal").modal('show');
    } 

    function defaultSuccessCallback(result) {
        if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
                $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
                setTimeout("$('.modal.in').modal('hide')",2000);                
                resetForm();
                getNetworks();
            }
            else {
                $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
                $.each(result.errors, function(k,v) {
                  $("#"+k+"-help").closest('div').addClass("has-error");
                  $("#"+k+"-help").html(v);
                });                       
            }
            setTimeout("$('#flash-message').fadeOut()",2000);
        }   
    }  

    function setNetwork() {
        $.ajax({
            url: "{% url 'ip:setnetwork' %}",
            data: $("#set-network-address-form").serialize(),
            type: "POST",
            success: defaultSuccessCallback,
            error: defaultErrorCallback
        });            
    }  

      function getVlans() {
        $("#vlans-table-tbody").html("");

        function onSuccessCallback(result) {
            if(!jQuery.isEmptyObject(result)) {
                if(result.success == 1) {
                    for(x in result.data.vlans) {
                        $("#vlans-table-tbody").append(' \
                            <tr data-id="'+result.data.vlans[x].id+'"> \
                                <td>'+result.data.vlans[x].number+'</td> \
                                <td>'+result.data.vlans[x].name+'</td> \
                                <td>'+result.data.vlans[x].description+'</td> \
                                <td><a href="#" class="btn btn-primary edit-vlan">Edit</a><a href="#" class="btn btn-warning del-vlan">Delete</a></td> \
                            </tr>'
                        );
                    }
                }
                else {
                    $("#vlans-table-tbody").append("<tr><td colspan=4>Error fetching vlans listing.</td></tr>");
                }
            }   
        }  

        $.ajax({
            url: "{% url 'ip:getvlan' %}",
            type: "POST",
            success: onSuccessCallback,
            error: defaultErrorCallback
        });            
      } 

      function getVrfs() {
        $("#vrfs-table-tbody").html("");

        function onSuccessCallback(result) {
            if(!jQuery.isEmptyObject(result)) {
                $('#flash-message').fadeIn();
                if(result.success == 1) {
                    for(x in result.data.vrfs) {
                        $("#vrfs-table-tbody").append(' \
                            <tr data-id="'+result.data.vrfs[x].id+'"> \
                                <td>'+result.data.vrfs[x].distinguisher+'</td> \
                                <td>'+result.data.vrfs[x].name+'</td> \
                                <td>'+result.data.vrfs[x].description+'</td> \
                                <td><a href="#" class="btn btn-primary edit-vrf">Edit</a><a href="#" class="btn btn-warning del-vrf">Delete</a></td> \
                            </tr>'
                        );
                    }
                }
                else {
                    $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
                    $.each(result.errors, function(k,v) {
                      $("#"+k+"-help").closest('div').addClass("has-error");
                      $("#"+k+"-help").html(v);
                    });                       
                }
                setTimeout("$('#flash-message').fadeOut()",2000);
            }   
        }  

        $.ajax({
            url: "{% url 'ip:getvrf' %}",
            type: "POST",
            success: onSuccessCallback,
            error: defaultErrorCallback
        });            
      }

    function vrfDefaultSuccessCallback(result) {
        if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
                $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
                getVrfs();
                $('.modal.in').modal('hide');
            }
            else {
                $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
                $.each(result.errors, function(k,v) {
                  $("#"+k+"-help").closest('div').addClass("has-error");
                  $("#"+k+"-help").html(v);
                });                       
            }
            setTimeout("$('#flash-message').fadeOut()",2000);
        }   
    } 

      function deleteVrf() {
        $.ajax({
            url: "{% url 'ip:delvrf' %}",
            type: "POST",
            data: $("#vrf-form").serialize(),
            success: vrfDefaultSuccessCallback,
            error: defaultErrorCallback
        });            
      }

      function setVrf() {
        $.ajax({
            url: "{% url 'ip:setvrf' %}",
            type: "POST",
            data: $("#vrf-form").serialize(),
            success: vrfDefaultSuccessCallback,
            error: defaultErrorCallback
        });            
      }

    // Build and display Add Zone modal
    function build_vrf_modal(vrf_id=0, action="create", distinguisher="", name="", description="") {
        console.log(vrf_id);
        switch(action) {
          case 'delete':
            var modal_title = "Delete VRF";
            var modal_body = "Are you sure you want to delete the selected VRF?<form id='vrf-form'><input type='hidden' name='vrf_id' value='"+vrf_id+"' /></form>";
            var modal_onclick_action = "deleteVrf()";
            break;
          case 'edit':           
          case 'create':
          default:
            var modal_title = "Set VRF"; 
            var modal_onclick_action = "setVrf()";
            var modal_body = ' \
              <form id="vrf-form"> \
                <div class="form-group"> \
                    <label class="control-label col-md-3">Number</label> \
                    <div class="controls col-md-9"> \
                        <input class="form-control" id="vrf-distinguisher" name="distinguisher" type="text" value="'+distinguisher+'" /> \
                        <span id="distinguisher-help" class="help-block"></span> \
                    </div> \
                </div> \
                <div class="form-group"> \
                    <label class="control-label col-md-3">Name</label> \
                    <div class="controls col-md-9"> \
                        <input class="form-control" id="vrf-name" name="name" type="text" value="'+name+'" /> \
                        <span id="name-help" class="help-block"></span> \
                    </div> \
                </div> \
                <div class="form-group"> \
                    <label class="control-label col-md-3">Description</label> \
                    <div class="controls col-md-9"> \
                        <input class="form-control" id="vrf-description" name="description" type="text" value="'+description+'" /> \
                        <span id="description-help" class="help-block"></span> \
                    </div> \
                </div> \
                <input type="hidden" name="vrf_id" value="'+vrf_id+'"/> \
              </form>';            
            break;
        }

        buildModal(modal_title, modal_body, modal_onclick_action);            
    }      

    function vlanDefaultSuccessCallback(result) {
        if(!jQuery.isEmptyObject(result)) {
            $('#flash-message').fadeIn();
            if(result.success == 1) {
                $('#flash-message').html('<div class="alert alert-success">'+result.message+'</div>');
                getVlans();
                $('.modal.in').modal('hide');
            }
            else {
                $('#flash-message').html('<div class="alert alert-danger">'+result.message+'</div>');
                $.each(result.errors, function(k,v) {
                  $("#"+k+"-help").closest('div').addClass("has-error");
                  $("#"+k+"-help").html(v);
                });                       
            }
            setTimeout("$('#flash-message').fadeOut()",2000);
        }   
    }

    function deleteVlan() {
        $.ajax({
            url: "{% url 'ip:delvlan' %}",
            type: "POST",
            data: $("#vlan-form").serialize(),
            success: vlanDefaultSuccessCallback,
            error: defaultErrorCallback
        });            
    }

      function setVlan() {
        $.ajax({
            url: "{% url 'ip:setvlan' %}",
            type: "POST",
            data: $("#vlan-form").serialize(),
            success: vlanDefaultSuccessCallback,
            error: defaultErrorCallback
        });            
      }

    // Build and display Add Zone modal
    function build_vlan_modal(vlan_id=0, action="create", number="", name="", description="") {
        switch(action) {
          case 'delete':
            var modal_title = "Delete VLAN";
            var modal_body = "Are you sure you want to delete the selected VLAN?<form id='vlan-form'><input type='hidden' name='vlan_id' value='"+vlan_id+"' /></form>";
            var modal_onclick_action = "deleteVlan()";
            break;
          case 'edit':           
          case 'create':
          default:
            var modal_title = "Set VLAN"; 
            var modal_onclick_action = "setVlan()";
            var modal_body = ' \
              <form id="vlan-form"> \
                <div class="form-group"> \
                    <label class="control-label col-md-3">Number</label> \
                    <div class="controls col-md-9"> \
                        <input class="form-control" id="vlan-number" name="number" type="text" value="'+number+'" /> \
                        <span id="number-help" class="help-block"></span> \
                    </div> \
                </div> \
                <div class="form-group"> \
                    <label class="control-label col-md-3">Name</label> \
                    <div class="controls col-md-9"> \
                        <input class="form-control" id="vlan-name" name="name" type="text" value="'+name+'" /> \
                        <span id="name-help" class="help-block"></span> \
                    </div> \
                </div> \
                <div class="form-group"> \
                    <label class="control-label col-md-3">Description</label> \
                    <div class="controls col-md-9"> \
                        <input class="form-control" id="vlan-description" name="description" type="text" value="'+description+'" /> \
                        <span id="description-help" class="help-block"></span> \
                    </div> \
                </div> \
                <input type="hidden" name="vlan_id" value="'+vlan_id+'"/> \
              </form>';            
            break;
        }

        buildModal(modal_title, modal_body, modal_onclick_action);            
    }  


    // Fetch Networks
    function getNetworks() {
        // Destroy existing
        $("#networks-list-tbody").html("");

        // onSuccess callback function
        function onSuccessCallback(result) {
            if(!jQuery.isEmptyObject(result)) {
                if(result.success == 1) {
                    // AJAX call returned successful
                    for(x in result.data.networks) {
                        var tmp = '<tr data-id="'+result.data.networks[x].id+'"><td>';
                        if(result.data.networks[x].parent) {
                            tmp = tmp + '--';
                        }
                        tmp = tmp +result.data.networks[x].address+'</td> \
                            <td>/'+result.data.networks[x].cidr+'</td> \
                            <td>'+result.data.networks[x].vlan+'</td> \
                            <td>'+result.data.networks[x].owner+'</td> \
                            <td>'+result.data.networks[x].description+'</td> \
                            <td> \
                                <a href="#" class="btn-primary edit-network" role="button">Edit</a> \
                                <a href="#" class="btn-primary resize-network" role="button">Resize</a> \
                                <a href="#" class="btn-info split-network" role="button">Split</a> \
                                <a href="#" class="btn-warning truncate-network" role="button">Truncate</a> \
                            </td> \
                        </tr>'

                        $("#networks-list-tbody").append(tmp);

                        {% if parent %}
                            for(y in result.data.networks[x].usable_hosts) {
                                $("#ip_address").append('<OPTION>'+result.data.networks[x].usable_hosts[y]+'</OPTION>');
                            }
                        {% endif %}                            
                    }
                }
                else {
                    // AJAX call returned failed
                    $("#networks-list-tbody").html("<tr><td colspan=5>"+result.message+"</td></tr>");
                }           
            }
        }

        // Make AJAX call to retrieve Networks
        $.ajax({
            url: "{% url 'ip:getnetworks' %}",
            type: "POST",
            success: onSuccessCallback,
            error: defaultErrorCallback
        });        
    }

    // Fetch Networks
    function getSplitOptions(id) {
        // Destroy existing
        $("#split-select").html("");

        // onSuccess callback function
        function onSuccessCallback(result) {
            if(!jQuery.isEmptyObject(result)) {
                if(result.success == 1) {
                    // AJAX call returned successful
                    for(x in result.data.options) {
                        $("#split-select").append('<OPTION value="'+result.data.options[x].prefix+'">'+result.data.options[x].numnets+' x /'+result.data.options[x].prefix+' ('+result.data.options[x].numnets+' x '+result.data.options[x].numhosts+' hosts)</OPTION>');                  
                    }
                }       
            }
        }

        // Make AJAX call to retrieve Networks
        $.ajax({
            url: "{% url 'ip:getsplitopts' %}",
            type: "POST",
            data: {'networkaddress_id': id},
            success: onSuccessCallback,
            error: defaultErrorCallback
        });        
    }    

    // Build and display Add Zone modal
    function build_edit_network_modal(id, action="") {
        switch(action) {
          case 'truncate':
            var modal_title = "Truncate Network"; 
            var modal_onclick_action = "truncateNetwork()";
            var modal_body = 'Truncating will purge all IPAddress and PTR records belonging to subnet. Are you sure you wish to proceed?<form id="truncate-network-form"><input type="hidden" name="networkaddress_id" value="'+id+'" /></form>';
            break;          
          case 'resize':  
            var modal_title = "Resize Network"; 
            var modal_onclick_action = "resizeNetwork()";
            var modal_body = 'Any IPAddress objects belonging to Network must reside inside the new block or the request will fail.<form id="resize-network-form"><input type="hidden" name="networkaddress_id" value="'+id+'" /><input type="text" name="new_cidr" /></form>';
            break;
          case 'split':
          default:
            getSplitOptions(id);
            var modal_title = "Split Network"; 
            var modal_onclick_action = "splitNetwork()";
            var modal_body = ' \
                <form id="split-network-form" class="form"> \
                    <input type="hidden" name="networkaddress_id" value="'+id+'" /> \
                    <div>Number of Subnets: <select name="new_cidr" id="split-select" autocorrect="off"></select></div> \
                    <div>Group under: <input type="checkbox" name="group_under" / ></div> \
                </form>';
            break;
        }

        
        buildModal(modal_title, modal_body, modal_onclick_action);            
    }

      function splitNetwork() {
        $.ajax({
            url: "{% url 'ip:split' %}",
            type: "POST",
            data: $("#split-network-form").serialize(),
            success: defaultSuccessCallback,
            error: defaultErrorCallback
        });            
      }    

      function resizeNetwork() {
        $.ajax({
            url: "{% url 'ip:resize' %}",
            type: "POST",
            data: $("#resize-network-form").serialize(),
            success: defaultSuccessCallback,
            error: defaultErrorCallback
        });            
      }


      function truncateNetwork() {
        $.ajax({
            url: "{% url 'ip:truncate' %}",
            type: "POST",
            data: $("#truncate-network-form").serialize(),
            success: defaultSuccessCallback,
            error: defaultErrorCallback
        });            
      }

    // Fetch Networks
    function getNetwork(id) {
        resetForm();
        $("#id_address").attr("readonly", true);
        $("#id_cidr").attr("readonly", true);

        // onSuccess callback function
        function onSuccessCallback(result) {
            if(!jQuery.isEmptyObject(result)) {
                if(result.success == 1) {
                    // AJAX call returned successful
                    $("#id_address").val(result.data.network.address);
                    $("#id_cidr").val(result.data.network.cidr);
                    $("#id_description").val(result.data.network.description);
                    $("#id_parent").val(result.data.network.parent);
                    $("#id_vrf").val(result.data.network.vrf_pk);
                    $("#id_vlan").val(result.data.network.vlan_pk);
                    $("#id_owner").val(result.data.network.owner_pk);
                    $("#id_networkaddress_id").val(id);
                }
                else {
                    // AJAX call returned failed
                    $("#networks-list-tbody").html("<tr><td colspan=5>"+result.message+"</td></tr>");
                }           
            }
        }

        // Make AJAX call to retrieve Networks
        $.ajax({
            url: "{% url 'ip:getnetwork' %}",
            type: "POST",
            data: {'networkaddress_id': id},
            success: onSuccessCallback,
            error: defaultErrorCallback
        });        
    }      

    function resetForm() {
        $("#id_address").val("");
        $("#id_cidr").val("");
        $("#id_description").val("");
        $("#id_parent").val("");
        $("#id_vrf").val("");
        $("#id_vlan").val("");
        $("#id_owner").val("");
        $("#id_networkaddress_id").val("0");     

        $("#id_address").attr("readonly", false);   
        $("#id_cidr").attr("readonly", false);
    }
	</script>
{% endblock %}

{% block jquery_document_ready %}
    getVlans();
    getVrfs();
    getNetworks();

    $('#vlans-table-tbody')
        .on('click', 'a.del-vlan', function (e) {
            e.preventDefault();
            build_vlan_modal($(this).closest('tr').data('id'), "delete");
        })    
        .on('click', 'a.edit-vlan', function (e) {
            e.preventDefault();
            build_vlan_modal($(this).closest('tr').data('id'), "edit", $(this).closest('tr').find("td").eq(0).html(), $(this).closest('tr').find("td").eq(1).html(), $(this).closest('tr').find("td").eq(2).html());
        });

    $('#vrfs-table-tbody')
        .on('click', 'a.del-vrf', function (e) {
            e.preventDefault();
            build_vrf_modal($(this).closest('tr').data('id'), "delete");
        })    
        .on('click', 'a.edit-vrf', function (e) {
            e.preventDefault();
            build_vrf_modal($(this).closest('tr').data('id'), "edit", $(this).closest('tr').find("td").eq(0).html(), $(this).closest('tr').find("td").eq(1).html(), $(this).closest('tr').find("td").eq(2).html());
        });

    $('#networks-list-table')
        .on('click', 'a.edit-network', function (e) {
            e.preventDefault();
            getNetwork($(this).closest('tr').data('id'));
        })      
        .on('click', 'a.truncate-network', function (e) {
            e.preventDefault();
            build_edit_network_modal($(this).closest('tr').data('id'), "truncate");
        })   
        .on('click', 'a.resize-network', function (e) {
            e.preventDefault();
            build_edit_network_modal($(this).closest('tr').data('id'), "resize");
        })             
        .on('click', 'a.split-network', function (e) {
            e.preventDefault();
            build_edit_network_modal($(this).closest('tr').data('id'), "split");
        });        
{% endblock %}

{% block content %}
 <!-- BEGIN IP SPACE MANAGEMENT CONTENT -->
    <!-- BEGIN NETWORKADDRESS CONTAINER HEAD -->
    <div class="row page-head">
        <div class="col-md-12"><i class="fa fa-edit"></i>&nbsp;<h3 id="article-title">IP Space</h3></div>
    </div>
    <!-- END NETWORKADDRESS CONTAINER HEAD -->
    <!-- BEGIN NETWORKADDRESS CONTAINER BODY -->
	<div class="row">
        <div id="flash-message"></div>
      <form id="set-network-address-form">
        <input type="hidden" name="networkaddress_id" id="id_networkaddress_id" value="0" />
        {% for field in networkaddressform %}
          <div class="form-group">
            <label class="control-label col-md-3">{{ field.label_tag }}</label>
            <div class="controls col-md-9">
              {{ field|addcss:"form-control" }}
              <span id="{{ field.html_name }}-help" class="help-block"></span>
            </div>
          </div>
        {% endfor %}    

        <div class="form-actions">
          <div class="col-md-offset-3 col-md-9">
            <a class="btn btn-primary" onclick="setNetwork()"><i class="fa fa-plus"></i> Submit</a>
            <a class="btn btn-warning" onclick="resetForm()"><i class="fa fa-minus"></i> Reset</a>               
          </div>
        </div>                         
      </form>  
	</div>
    <!-- END NETWORKADDRESS CONTAINER BODY -->  

        <!-- BEGIN NETWORKS TABLE -->
        <table class="table table-hover" id="networks-list-table">
            <thead>
                <tr>
                    <th>Network Address</th>
                    <th>CIDR</th>
                    <th>Vlan</th>
                    <th>Owner</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="networks-list-tbody"></tbody>
        </table>
        <!-- END NETWORKS TABLE -->



    <!-- BEGIN VLAN CONTAINER HEAD -->
    <div class="row page-head">
        <div class="col-md-6"><i class="fa fa-edit"></i>&nbsp;<h3 id="article-title">VLANs</h3></div>
        <div class="col-md-6 text-right">        
            <div class="btn-group">
                <a role="button" class="badge" onclick="build_vlan_modal()">Create <i class="fa fa-plus"></i></a>                
            </div>
        </div>           
    </div>
    <!-- END VLAN CONTAINER HEAD -->
    <!-- BEGIN VLAN CONTAINER BODY -->
    <div class="row">
        <!-- BEGIN VLAN TABLE -->
        <table id="vlans-table" class="table table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>&nbsp;</th>
                </tr>
            </thead>
            <tbody id="vlans-table-tbody">
            </tbody>
        </table>
        <!-- END VLAN TABLE -->
    </div>
    <!-- END VLAN CONTAINER BODY -->

    <!-- BEGIN VRF CONTAINER HEAD -->
    <div class="row page-head">
        <div class="col-md-6"><i class="fa fa-edit"></i>&nbsp;<h3 id="article-title">VRFs</h3></div>
        <div class="col-md-6 text-right">        
            <div class="btn-group">
                <a role="button" class="badge" onclick="build_vrf_modal()">Create <i class="fa fa-plus"></i></a>                
            </div>
        </div>           
    </div>
    <!-- END VRF CONTAINER HEAD -->
    <!-- BEGIN VRF CONTAINER BODY -->
    <div class="row">
        <!-- BEGIN VRF TABLE -->
        <table id="vrfs-table" class="table table-hover">
            <thead>
                <tr>
                    <th>Distinguisher</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>&nbsp;</th>
                </tr>
            </thead>
            <tbody id="vrfs-table-tbody">
            </tbody>
        </table>
        <!-- END VRF TABLE -->
    </div>
    <!-- END VRF CONTAINER BODY -->    

    <!-- BEGIN MODAL -->
    <div id="mmodal" class="modal fade in" role="dialog" aria-labelledby="model-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- BEGIN MODAL HEADER -->
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h3 id="mlabel"></h3>
                </div>
                <!-- END MODAL HEADER -->
                <!-- BEGIN MODAL BODY -->
                <div class="modal-body">
                    <div id="flash-message"></div>
                    <div class="well" id="mbody"></div>
                </div>
                <!-- END MODAL BODY -->
                <!-- BEGIN MODAL FOOTER -->
                <div class="modal-footer" id="modalfooter">
                    <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Close</button>
                    <button id="msave" class="btn btn-primary">Ok</button>
                </div>
                <!-- END MODAL FOOTER -->
            </div>
        </div>
    </div>
    <!-- END MODAL -->    
 <!-- END IP SPACE MANAGEMENT CONTENT -->   
{% endblock %}